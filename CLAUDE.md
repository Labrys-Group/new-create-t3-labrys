# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a T3 Turbo monorepo template - a Turborepo-based full-stack TypeScript project with multiple applications (Next.js, Expo, Tanstack Start) sharing common packages. Replace `@acme` namespace with your organization/project name throughout the codebase.

**Tech Stack:**
- Turborepo for monorepo management
- tRPC v11 for type-safe APIs
- Drizzle ORM with Supabase (edge-compatible)
- Better Auth for authentication
- Tailwind CSS v4 (NativeWind v5 for Expo)
- React 19

**System Requirements:**
- Node.js: ^22.21.0
- pnpm: ^10.19.0

## Coding Standards

Follow these standards when working in this codebase:

{{file:.standards/typescript.md}}

{{file:.standards/react.md}}

{{file:.standards/git.md}}

## Common Commands

### Initial Setup
```bash
pnpm i                              # Install dependencies
cp .env.example .env                # Configure environment variables
pnpm db:push                        # Push Drizzle schema to database
pnpm auth:generate                  # Generate Better Auth schema (required before first run)
```

### Development
```bash
pnpm dev                            # Run all apps in watch mode
pnpm dev:next                       # Run only Next.js app with dependencies
pnpm db:studio                      # Open Drizzle Studio
```

### Build & Quality
```bash
pnpm build                          # Build all packages
pnpm typecheck                      # Type-check all packages
pnpm lint                           # Lint all packages
pnpm lint:fix                       # Auto-fix lint issues
pnpm format                         # Check formatting
pnpm format:fix                     # Auto-fix formatting
pnpm lint:ws                        # Check monorepo workspace consistency with sherif
```

### UI & Package Management
```bash
pnpm ui-add                         # Add shadcn/ui component (interactive)
pnpm turbo gen init                 # Generate new package scaffold
```

### Platform-Specific
```bash
pnpm android                        # Run Expo on Android
pnpm ios                            # Run Expo on iOS
```

## Monorepo Architecture

### Apps (`apps/`)
Three application entry points sharing the same backend packages:

- **nextjs**: Next.js 15 web app with App Router, tRPC client
- **expo**: React Native mobile app with Expo Router, requires OAuth proxy configuration
- **tanstack-start**: Alternative web app using Tanstack Start (can delete if unused)

### Shared Packages (`packages/`)

#### `@acme/api`
tRPC router definitions. The core API layer.
- Entry: `src/root.ts` - exports `appRouter` and `AppRouter` type
- Routers in `src/router/` - modular route definitions
- **Production dependency** for Next.js/Tanstack Start (server-side)
- **Dev dependency only** for Expo (type safety without shipping backend code)

#### `@acme/auth`
Better Auth configuration wrapper.
- `src/index.ts` - `initAuth()` factory function
- `script/auth-cli.ts` - CLI-only config for schema generation (DO NOT import in app code)
- Requires running `pnpm auth:generate` to create `@acme/db/src/auth-schema.ts`

#### `@acme/db`
Database layer using Drizzle ORM.
- `src/schema.ts` - Drizzle table definitions
- `src/auth-schema.ts` - Auto-generated by Better Auth CLI (git-ignored)
- `src/client.ts` - Database client instance
- Configured for **edge runtime** with Vercel Postgres driver
- To use non-edge: remove `export const runtime = "edge"` from API routes

#### `@acme/validators`
Shared validation schemas (e.g., Zod schemas for inputs).
- Use for runtime code shared between client/server
- Prevents leaking backend logic to clients

#### `@acme/ui`
UI component library using shadcn/ui.
- Add components via `pnpm ui-add`
- Shared between web apps (not Expo)

### Tooling (`tooling/`)
Shared configurations for consistent development experience:
- `eslint` - ESLint presets
- `prettier` - Prettier config
- `tailwind` - Tailwind theme and config
- `typescript` - Base tsconfig files
- `github` - GitHub Actions workflows

## Authentication Setup

Better Auth requires schema generation before first use:
```bash
pnpm auth:generate
```

This runs the Better Auth CLI using `packages/auth/script/auth-cli.ts` and outputs auth tables to `packages/db/src/auth-schema.ts`.

**For Expo OAuth to work**, deploy Next.js app first or configure local IP in OAuth provider. The OAuth proxy plugin (`@better-auth/expo`) forwards requests through your deployed Next.js app for stable callback URLs.

## Environment Variables

Required variables (see `.env.example`):
- `POSTGRES_URL` - Supabase connection string
- `AUTH_SECRET` - Generate with `openssl rand -base64 32`
- `AUTH_DISCORD_ID` - Discord OAuth client ID
- `AUTH_DISCORD_SECRET` - Discord OAuth client secret
- `AUTH_REDIRECT_PROXY_URL` - (Optional) Production URL for OAuth proxy

## Development Workflows

### Adding a New Feature
1. Define tRPC router in `packages/api/src/router/`
2. Add to `packages/api/src/root.ts` appRouter
3. Create DB schema in `packages/db/src/schema.ts`
4. Run `pnpm db:push` to sync database
5. Implement UI in app(s)

### Adding a New Package
```bash
pnpm turbo gen init
```
Follow prompts to scaffold a new package with proper tsconfig/tooling setup.

### Working with Database
- Modify schema: Edit `packages/db/src/schema.ts`
- Apply changes: `pnpm db:push`
- Explore data: `pnpm db:studio`

### Creating Pull Requests
This repository includes a PR template at `.github/PULL_REQUEST_TEMPLATE.md` with the following structure:
- **Purpose**: What the PR accomplishes and why the change is needed
- **Approach**: Implementation details and key technical decisions
- **Testing**: Test scenarios and verification steps
- **Breaking Changes**: Any breaking changes or "None"

Use the `/pr` slash command to automatically generate a PR description using this template based on your branch's diff and commits.

### Preventing Backend Code Leaks
The `api` package should be:
- **Production dependency**: in Next.js/Tanstack Start (server apps)
- **Dev dependency**: in Expo (type-only imports)

This ensures backend code never bundles into client apps while maintaining full type safety.

## Deployment

### Next.js (Vercel)
1. Deploy from `apps/nextjs` folder
2. Add `POSTGRES_URL` environment variable
3. Configure OAuth provider with production callback URL

### Expo
1. Update `getBaseUrl()` in Expo app to point to production API
2. Use EAS Build: `eas build --platform ios/android --profile production`
3. Submit to stores: `eas submit --platform ios/android --latest`
4. OTA updates: `eas update --auto`

## Key Patterns

### Type Safety Across Apps
The monorepo enables full type safety from database → API → client:
```
DB Schema (Drizzle) → tRPC Router → AppRouter type → Client (tRPC hooks)
```

### Turborepo Task Dependencies
Tasks run in dependency order (defined in `turbo.json`):
- `build` depends on `^build` (build dependencies first)
- `lint`/`typecheck` depend on `^topo` and `^build`
- `dev` runs with `--continue` flag (don't stop on errors)

### Package References
Use workspace protocol for internal deps:
```json
"dependencies": {
  "@acme/db": "workspace:*"
}
```
